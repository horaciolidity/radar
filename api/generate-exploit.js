import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    runtime: 'edge', // Use Edge Runtime for better performance
};

export default async function handler(req) {
    if (req.method !== 'POST') {
        return new Response(JSON.stringify({ error: 'Method not allowed' }), {
            status: 405,
            headers: { 'Content-Type': 'application/json' }
        });
    }

    try {
        const { prompt } = await req.json();

        // Check for API Key in environment variables
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) {
            return new Response(JSON.stringify({ success: false, error: "Server missing GEMINI_API_KEY" }), {
                status: 500,
                headers: { 'Content-Type': 'application/json' }
            });
        }

        // Expanded list of models to try, prioritizing newer/cheaper ones
        const modelsToTry = [
            "gemini-1.5-flash",
            "gemini-1.5-flash-latest",
            "gemini-1.5-pro",
            "gemini-pro"
        ];

        let lastError = null;

        for (const modelName of modelsToTry) {
            try {
                console.log(`[Generate Exploit] Attempting with model: ${modelName}`);
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: modelName });

                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();

                // Extract JSON from potential markdown blocks
                const jsonMatch = text.match(/\{[\s\S]*\}/);

                if (!jsonMatch) {
                    console.warn(`[Generate Exploit] Model ${modelName} returned invalid JSON structure.`);
                    throw new Error("No JSON found in response");
                }

                const json = JSON.parse(jsonMatch[0]);

                return new Response(JSON.stringify({ success: true, exploit: json }), {
                    status: 200,
                    headers: { 'Content-Type': 'application/json' }
                });

            } catch (e) {
                console.warn(`[Generate Exploit] Model ${modelName} failed:`, e.message);
                lastError = e;
                // Continue to next model
            }
        }

        // If all failed
        console.error("[Generate Exploit] All AI models failed:", lastError);
        return new Response(JSON.stringify({
            success: false,
            error: lastError ? `AI generation failed (Last error: ${lastError.message})` : "AI generation failed"
        }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
        });

    } catch (e) {
        console.error("[Generate Exploit] Fatal Error:", e);
        return new Response(JSON.stringify({ success: false, error: e.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
        });
    }
}
