import { GoogleGenerativeAI } from '@google/generative-ai';

export const config = {
    runtime: 'edge', // Use Edge Runtime for better performance
};

export default async function handler(req) {
    if (req.method !== 'POST') {
        return new Response(JSON.stringify({ error: 'Method not allowed' }), {
            status: 405, headers: { 'Content-Type': 'application/json' }
        });
    }

    try {
        const { prompt } = await req.json();

        // 1. TRY GROQ (Llama 3) - Extremely Fast & Free Beta
        if (process.env.GROQ_API_KEY) {
            try {
                console.log("[Generate Exploit] Attempting with GROQ (llama-3.3-70b-versatile)...");
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${process.env.GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: "You are a smart contract exploit expert. Output JSON only." },
                            { role: "user", content: prompt }
                        ],
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) throw new Error(`Groq API Error: ${response.statusText}`);

                const data = await response.json();
                const content = data.choices[0].message.content;
                const json = JSON.parse(content);

                return new Response(JSON.stringify({ success: true, exploit: json }), {
                    status: 200, headers: { 'Content-Type': 'application/json' }
                });
            } catch (e) {
                console.warn("[Generate Exploit] Groq failed, falling back to Gemini:", e.message);
            }
        }

        // 2. FALLBACK TO GEMINI
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) {
            // If we tried Groq and it failed, and we have no Gemini key, return the Groq error or generic failure
            // Note: We don't have access to the specific Groq error variable 'e' from above block here easily without restructuring,
            // but we know Groq was attempted if process.env.GROQ_API_KEY is true.

            // However, cleaner logic: If no Gemini key, we can't fallback. 
            // If Groq key existed, we already tried it. If we are here, it means Groq failed (caught in catch block).
            // So we should report that failure if no Gemini key exists.

            return new Response(JSON.stringify({
                success: false,
                error: process.env.GROQ_API_KEY ? "Groq API failed and no Gemini key for fallback." : "Missing both GROQ_API_KEY and GEMINI_API_KEY"
            }), {
                status: 500, headers: { 'Content-Type': 'application/json' }
            });
        }

        // Use only widely available free tier models
        const modelsToTry = ["gemini-1.5-flash", "gemini-1.5-flash-latest"];
        let lastError = null;

        for (const modelName of modelsToTry) {
            try {
                console.log(`[Generate Exploit] Attempting with Gemini model: ${modelName}`);
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: modelName });

                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();

                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("No JSON found");

                return new Response(JSON.stringify({ success: true, exploit: JSON.parse(jsonMatch[0]) }), {
                    status: 200, headers: { 'Content-Type': 'application/json' }
                });
            } catch (e) {
                console.warn(`[Generate Exploit] Gemini ${modelName} failed:`, e.message);
                lastError = e;
            }
        }

        throw lastError || new Error("All AI providers failed");

    } catch (e) {
        return new Response(JSON.stringify({ success: false, error: e.message }), {
            status: 500, headers: { 'Content-Type': 'application/json' }
        });
    }
}
